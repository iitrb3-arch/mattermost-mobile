name: Build Mattermost Mobile APK (Release Signed)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install yarn
        run: npm install -g yarn

      - name: Configure Git identity
        run: |
          git config --global user.email "iitrb3@gmail.com"
          git config --global user.name "iitrb3-arch"

      - name: Disable Solidarity checks
        run: |
          if [ -f package.json ]; then
            sed -i '/"preinstall"/d' package.json || true
          fi
          if [ -f scripts/preinstall.sh ]; then
            echo "exit 0" > scripts/preinstall.sh
          fi
          export SKIP_SOLIDARITY=1

      - name: Install dependencies
        run: |
          export SKIP_SOLIDARITY=1
          yarn install --ignore-engines --ignore-scripts

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Generate keystore
        run: |
          keytool -genkeypair -v \
            -keystore release.keystore \
            -alias matterkey \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass mypass123 \
            -keypass mypass123 \
            -dname "CN=iitrb3-arch, OU=Dev, O=Workspace, L=Tehran, ST=Tehran, C=IR"

      - name: Patch Gradle configs
        run: |
          echo "Patching Gradle configuration files..."
          find . -type f -name "build.gradle" -print0 | while IFS= read -r -d '' file; do
            sed -i 's/compileSdkVersion *[0-9][0-9]*/compileSdkVersion 34/' "$file" || true
            sed -i 's/targetSdkVersion *[0-9][0-9]*/targetSdkVersion 34/' "$file" || true
            sed -i 's/jcenter()/mavenCentral()/' "$file" || true
          done

      # üîç ŸÖÿ±ÿ≠ŸÑŸá‚Äå€å ÿ¨ÿØ€åÿØ ÿ®ÿ±ÿß€å ŸÜŸÖÿß€åÿ¥ ÿ≥ÿßÿÆÿ™ÿßÿ± ŸÅÿß€åŸÑ‚ÄåŸáÿß
      - name: Debug - list project files
        run: |
          echo "üóÇ Listing project structure (showing .js, .jsx, .tsx files)..."
          find . -maxdepth 3 -type f \( -name "*.js" -o -name "*.jsx" -o -name "*.tsx" \) | sort || true
          echo "‚úÖ Done listing files."

      # üîé ÿ™ÿ¥ÿÆ€åÿµ ÿÆŸàÿØ⁄©ÿßÿ± entry file ÿßÿ≤ ÿ®€åŸÜ ŸÅÿß€åŸÑ‚ÄåŸáÿß€å ŸÖŸàÿ¨ŸàÿØ
      - name: Detect entry file for JS bundle
        id: detect-entry
        run: |
          echo "üîé Detecting entry file..."
          if [ -f "index.js" ]; then echo "entry=index.js" >> $GITHUB_ENV; echo "‚úÖ Found index.js";
          elif [ -f "index.android.js" ]; then echo "entry=index.android.js" >> $GITHUB_ENV; echo "‚úÖ Found index.android.js";
          elif [ -f "src/index.js" ]; then echo "entry=src/index.js" >> $GITHUB_ENV; echo "‚úÖ Found src/index.js";
          elif [ -f "app/index.js" ]; then echo "entry=app/index.js" >> $GITHUB_ENV; echo "‚úÖ Found app/index.js";
          elif [ -f "app/mattermost.js" ]; then echo "entry=app/mattermost.js" >> $GITHUB_ENV; echo "‚úÖ Found app/mattermost.js";
          elif [ -f "app/mattermost.tsx" ]; then echo "entry=app/mattermost.tsx" >> $GITHUB_ENV; echo "‚úÖ Found app/mattermost.tsx";
          elif [ -f "app/start.js" ]; then echo "entry=app/start.js" >> $GITHUB_ENV; echo "‚úÖ Found app/start.js";
          elif [ -f "app/start.tsx" ]; then echo "entry=app/start.tsx" >> $GITHUB_ENV; echo "‚úÖ Found app/start.tsx";
          else
            echo "‚ùå No entry file found. Please check the list above in the 'Debug - list project files' step.";
            exit 1;
          fi
          echo "Using entry file: $entry"

      - name: Build JS bundle manually (auto-detected entry)
        run: |
          export NODE_OPTIONS="--max_old_space_size=4096"
          mkdir -p android/app/src/main/assets
          npx react-native bundle \
            --platform android \
            --dev false \
            --entry-file ${{ env.entry }} \
            --bundle-output android/app/src/main/assets/index.android.bundle \
            --assets-dest android/app/src/main/res \
            --reset-cache

      - name: Build Android Release APK
        working-directory: android
        run: |
          export NODE_OPTIONS="--max_old_space_size=4096"
          ./gradlew clean
          ./gradlew assembleRelease --no-daemon --warning-mode all \
            -Pandroid.injected.signing.store.file=../release.keystore \
            -Pandroid.injected.signing.store.password=mypass123 \
            -Pandroid.injected.signing.key.alias=matterkey \
            -Pandroid.injected.signing.key.password=mypass123

      - name: Upload Signed Release APK
        uses: actions/upload-artifact@v4
        with:
          name: mattermost-release-apk
          path: android/app/build/outputs/apk/release/app-release.apk
