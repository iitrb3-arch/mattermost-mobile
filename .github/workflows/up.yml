name: Build Mattermost Mobile APK (Release Signed)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ گرفتن سورس پروژه از ریپو
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ نصب Node.js (برای React Native)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # 3️⃣ نصب yarn
      - name: Install yarn
        run: npm install -g yarn

      # 4️⃣ تنظیم نام و ایمیل گیت برای عبور از تست‌ها
      - name: Configure Git identity
        run: |
          git config --global user.email "iitrb3@gmail.com"
          git config --global user.name "iitrb3-arch"

      # 5️⃣ نصب وابستگی‌ها (و غیرفعال کردن چک Solidarity)
      - name: Install dependencies (skip Solidarity checks)
        run: |
          export SKIP_SOLIDARITY=1
          echo "exit 0" > scripts/preinstall.sh
          yarn install --ignore-engines

      # 6️⃣ نصب JDK 17 برای Gradle/Android build
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # 7️⃣ ساخت keystore برای امضای APK
      - name: Generate keystore
        run: |
          keytool -genkeypair -v \
            -keystore release.keystore \
            -alias matterkey \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass mypass123 \
            -keypass mypass123 \
            -dname "CN=iitrb3-arch, OU=Dev, O=Workspace, L=Tehran, ST=Tehran, C=IR"

      # 8️⃣ اجرای build اندروید برای نسخه‌ی release
      - name: Build Android Release APK
        working-directory: android
        run: |
          ./gradlew assembleRelease \
            -Pandroid.injected.signing.store.file=../release.keystore \
            -Pandroid.injected.signing.store.password=mypass123 \
            -Pandroid.injected.signing.key.alias=matterkey \
            -Pandroid.injected.signing.key.password=mypass123

      # 9️⃣ آپلود فایل خروجی برای دانلود از بخش Artifacts
      - name: Upload Signed Release APK
        uses: actions/upload-artifact@v4
        with:
          name: mattermost-release-apk
          path: android/app/build/outputs/apk/release/app-release.apk
