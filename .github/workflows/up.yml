name: Build Mattermost Mobile APK (Release Signed)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install yarn
        run: npm install -g yarn

      - name: Configure Git identity
        run: |
          git config --global user.email "iitrb3@gmail.com"
          git config --global user.name "iitrb3-arch"

      - name: Disable Solidarity checks
        run: |
          if [ -f package.json ]; then
            sed -i '/"preinstall"/d' package.json || true
          fi
          if [ -f scripts/preinstall.sh ]; then
            echo "exit 0" > scripts/preinstall.sh
          fi
          export SKIP_SOLIDARITY=1

      - name: Install dependencies
        run: |
          export SKIP_SOLIDARITY=1
          yarn install --ignore-engines --ignore-scripts

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Generate keystore
        run: |
          keytool -genkeypair -v \
            -keystore release.keystore \
            -alias matterkey \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass mypass123 \
            -keypass mypass123 \
            -dname "CN=iitrb3-arch, OU=Dev, O=Workspace, L=Tehran, ST=Tehran, C=IR"

      - name: Patch Gradle configs
        run: |
          echo "Patching Gradle configuration files..."
          find . -type f -name "build.gradle" -print0 | while IFS= read -r -d '' file; do
            sed -i 's/compileSdkVersion *[0-9][0-9]*/compileSdkVersion 34/' "$file" || true
            sed -i 's/targetSdkVersion *[0-9][0-9]*/targetSdkVersion 34/' "$file" || true
            sed -i 's/jcenter()/mavenCentral()/' "$file" || true
          done

      # ğŸ‘‡ Ø¬Ø¯ÛŒØ¯: Ù†Ù…Ø§ÛŒØ´ Ø¯Ù‚ÛŒÙ‚ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø±Ø§ÛŒ ÛŒØ§ÙØªÙ† entry file
      - name: Deep debug - show all JS files (depth 5)
        run: |
          echo "ğŸ“‚ Listing all possible entry files up to 5 levels deep..."
          find . -maxdepth 5 -type f \( -name "*.js" -o -name "*.jsx" -o -name "*.tsx" \) | sort
          echo "âœ… Above is your file list. Look for something like index.js, app.js, main.js, or mattermost.js"
          echo "âš ï¸ Copy the correct relative path (like src/app/index.js) and send it to me."

      # â›”ï¸ Ø¯Ø± Ø§ÛŒÙ† Ù…Ø±Ø­Ù„Ù‡ Ø¯ÛŒÚ¯Ù‡ Ø­Ø¯Ø³ Ù†Ù…ÛŒâ€ŒØ²Ù†Ù‡Ø› ÙÙ‚Ø· Ù†Ù…Ø§ÛŒØ´ Ù…ÛŒâ€ŒØ¯Ù‡
      - name: Stop build if entry not set
        run: |
          echo "âŒ No entry file set yet. Please check the 'Deep debug' step output above."
          echo "â„¹ï¸ Once you find the correct entry file, tell me its path (for example: src/app/mattermost.js)"
          exit 1
