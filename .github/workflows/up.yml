name: Build Mattermost Mobile APK (Release Signed)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install yarn
        run: npm install -g yarn

      - name: Configure Git identity
        run: |
          git config --global user.email "iitrb3@gmail.com"
          git config --global user.name "iitrb3-arch"

      # Solidarity و preinstall را غیر فعال می‌کنیم
      - name: Disable only Solidarity preinstall
        run: |
          if [ -f package.json ]; then
            node -e "const fs=require('fs');const f='package.json';const p=JSON.parse(fs.readFileSync(f,'utf8'));if(p.scripts&&p.scripts.preinstall){delete p.scripts.preinstall;fs.writeFileSync(f,JSON.stringify(p,null,2));console.log('Removed scripts.preinstall');}else{console.log('No scripts.preinstall to remove');}"
          fi
          if [ -f scripts/preinstall.sh ]; then echo 'exit 0' > scripts/preinstall.sh; fi

      - name: Install dependencies (allow postinstall)
        run: yarn install --ignore-engines

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Generate keystore
        run: |
          keytool -genkeypair -v \
            -keystore release.keystore \
            -alias matterkey \
            -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass mypass123 \
            -keypass mypass123 \
            -dname "CN=iitrb3-arch, OU=Dev, O=Workspace, L=Tehran, ST=Tehran, C=IR"

      - name: Ensure dist assets + fonts + sounds (fallback)
        run: |
          set -e
          COMPASS_ICONS="node_modules/@mattermost/compass-icons/font/compass-icons.ttf"
          if [ -f "$COMPASS_ICONS" ]; then
            mkdir -p assets/fonts android/app/src/main/assets/fonts
            cp -f "$COMPASS_ICONS" assets/fonts/ || true
            cp -f "$COMPASS_ICONS" android/app/src/main/assets/fonts/ || true
          fi
          mkdir -p dist/assets
          if [ -f scripts/generate-assets.js ]; then node scripts/generate-assets.js || true; fi
          if [ ! -d dist/assets/i18n ]; then
            mkdir -p dist/assets/i18n
            if [ -d app/assets/i18n ]; then cp -f app/assets/i18n/*.json dist/assets/i18n/ 2>/dev/null || true; fi
            if [ -d assets/i18n ]; then cp -f assets/i18n/*.json dist/assets/i18n/ 2>/dev/null || true; fi
          fi
          if [ -d assets/sounds ]; then
            mkdir -p android/app/src/main/res/raw/
            cp -f assets/sounds/* android/app/src/main/res/raw/ || true
          fi

      # 1) نصب پُلی‌فیل
      - name: Ensure 'events' polyfill for React Native
        run: |
          node -e "try{require.resolve('events');process.exit(0)}catch(e){process.exit(1)}" || yarn add events@3

      # 2) ساخت مترو کانفیگ موقت و merge با کانفیگ پروژه (اگر هست)
      - name: Create metro override (map node core 'events')
        run: |
          cat > metro.override.config.js <<'EOF'
          let base = {};
          try { base = require('./metro.config'); } catch (e) {}

          // تلاش برای گرفتن getDefaultConfig از @react-native/metro-config
          let getDefaultConfig, mergeConfig;
          try {
            ({getDefaultConfig, mergeConfig} = require('@react-native/metro-config'));
          } catch (e) {
            //Fallback برای نسخه‌های قدیمی
            ({getDefaultConfig, mergeConfig} = require('metro-config'));
          }

          const path = require('path');
          const defaultConfig = getDefaultConfig(__dirname);
          const merged = (mergeConfig ? mergeConfig(defaultConfig, base) : {...defaultConfig, ...base});

          const eventsPath = require.resolve('events/');
          merged.resolver = {
            ...(merged.resolver || {}),
            extraNodeModules: {
              ...((merged.resolver && merged.resolver.extraNodeModules) || {}),
              events: eventsPath,
            },
          };

          module.exports = merged;
          EOF

      - name: Detect JS entry file
        id: detect_entry
        run: |
          if [ -f index.ts ]; then
            echo "entry=index.ts" >> $GITHUB_OUTPUT
          elif [ -f index.js ]; then
            echo "entry=index.js" >> $GITHUB_OUTPUT
          else
            echo "❌ No entry file (index.ts/js) at repo root"; ls -la
            exit 1
          fi

      - name: Build JS bundle manually (with metro override)
        env:
          NODE_OPTIONS: --max_old_space_size=4096
        run: |
          ENTRY="${{ steps.detect_entry.outputs.entry }}"
          echo "Using entry: $ENTRY"
          mkdir -p android/app/src/main/assets
          npx react-native bundle \
            --config metro.override.config.js \
            --platform android \
            --dev false \
            --entry-file "$ENTRY" \
            --bundle-output android/app/src/main/assets/index.android.bundle \
            --assets-dest android/app/src/main/res \
            --reset-cache

      - name: Build Android Release APK
        working-directory: android
        env:
          NODE_OPTIONS: --max_old_space_size=4096
        run: |
          ./gradlew clean
          ./gradlew assembleRelease -x :app:createBundleReleaseJsAndAssets \
            --no-daemon --warning-mode all \
            -Pandroid.injected.signing.store.file=../release.keystore \
            -Pandroid.injected.signing.store.password=mypass123 \
            -Pandroid.injected.signing.key.alias=matterkey \
            -Pandroid.injected.signing.key.password=mypass123

      - name: Verify APK exists
        run: |
          test -f android/app/build/outputs/apk/release/app-release.apk || (echo "APK not found!" && exit 1)

      - name: Upload Signed Release APK
        uses: actions/upload-artifact@v4
        with:
          name: mattermost-release-apk
          path: android/app/build/outputs/apk/release/app-release.apk
          if-no-files-found: error

      # (اختیاری) ساخت AAB
      - name: Build Android App Bundle (AAB)
        working-directory: android
        env:
          NODE_OPTIONS: --max_old_space_size=4096
        run: |
          ./gradlew bundleRelease -x :app:createBundleReleaseJsAndAssets \
            --no-daemon --warning-mode all \
            -Pandroid.injected.signing.store.file=../release.keystore \
            -Pandroid.injected.signing.store.password=mypass123 \
            -Pandroid.injected.signing.key.alias=matterkey \
            -Pandroid.injected.signing.key.password=mypass123

      - name: Verify AAB exists
        run: |
          test -f android/app/build/outputs/bundle/release/app-release.aab || (echo "AAB not found!" && exit 1)

      - name: Upload Signed Release AAB
        uses: actions/upload-artifact@v4
        with:
          name: mattermost-release-aab
          path: android/app/build/outputs/bundle/release/app-release.aab
          if-no-files-found: error
